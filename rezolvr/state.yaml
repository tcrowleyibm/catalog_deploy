environmentVars:
  dbEnvProps:
  - name: db_host
    value: mydb-service
  - name: db_username
    value: abetterusername
  - name: db_password
    value: passwordie
  - name: db_port
    value: "5432"
components:
- name: postgresdb
  type: resource.db.postgres
  driver: ""
  description: Locally-used database
  provides:
  - name: mydb
    type: service.db.postgres
    params:
    - name: db_port
      formula: '{{with(index .Needs "environment.properties:dbEnvProps")}}{{.Params.db_port.Value}}{{end}}'
      value: "5432"
    - name: db_name
      value: postgres
    - name: db_host
      formula: '{{with(index .Needs "environment.properties:dbEnvProps")}}{{.Params.db_host.Value}}{{end}}'
      value: mydb-service
    - name: containerName
      formula: '{{.Component.Name}}'
      value: postgresdb
    - name: imageName
      value: postgres
    - name: image.tag
      value: latest
    - name: db_username
      formula: '{{with(index .Needs "environment.properties:dbEnvProps")}}{{.Params.db_username.Value}}{{end}}'
      value: abetterusername
    - name: db_password
      formula: '{{with(index .Needs "environment.properties:dbEnvProps")}}{{.Params.db_password.Value}}{{end}}'
      value: passwordie
  uses:
  - name: ""
    type: environment
    params:
    - name: POSTGRES_PASSWORD
      formula: '{{with(index .Needs "environment.properties:dbEnvProps")}}{{.Params.db_password.Value}}{{end}}'
      value: passwordie
    - name: POSTGRES_USER
      formula: '{{with(index .Needs "environment.properties:dbEnvProps")}}{{.Params.db_username.Value}}{{end}}'
      value: abetterusername
  needs:
  - name: dbEnvProps
    type: environment.properties
    params:
    - name: db_username
      value: abetterusername
      required: true
    - name: db_password
      value: passwordie
      required: true
    - name: db_port
      value: "5432"
      defaultValue: "5432"
    - name: db_host
      value: mydb-service
      required: true
- name: catalog
  type: resource.web.app
  driver: ""
  description: A catalog for fishing charters
  provides:
  - name: catalogapp
    type: service.web.app
    params:
    - name: path
      value: /dbtime
    - name: port
      value: "3001"
    - name: imageName
      formula: '{{.Component.Name}}'
      value: catalog
  uses:
  - name: ""
    type: environment
    params:
    - name: DB_PORT
      formula: '{{with(index .Needs "service.db.postgres:mydb")}}{{.Params.db_port.Value}}{{end}}'
      value: "5432"
    - name: DB_NAME
      formula: '{{with(index .Needs "service.db.postgres:mydb")}}{{.Params.db_name.Value}}{{end}}'
      value: postgres
    - name: DB_HOST
      formula: '{{with(index .Needs "service.db.postgres:mydb")}}{{.Params.db_host.Value}}{{end}}'
      value: mydb-service
    - name: DB_USER
      formula: '{{with(index .Needs "service.db.postgres:mydb")}}{{.Params.db_username.Value}}{{end}}'
      value: abetterusername
    - name: DB_PW
      formula: '{{with(index .Needs "service.db.postgres:mydb")}}{{.Params.db_password.Value}}{{end}}'
      value: passwordie
  needs:
  - name: mydb
    type: service.db.postgres
    params:
    - name: db_username
      value: abetterusername
      required: true
    - name: db_password
      value: passwordie
      required: true
    - name: db_port
      value: "5432"
      required: true
    - name: db_name
      value: postgres
      required: true
    - name: db_host
      value: mydb-service
      required: true
